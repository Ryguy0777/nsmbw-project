// d_profile_static.cpp
// NSMBW .text: 0x801018C0 - 0x801018E0

#include "d_profile.h"

#include "d_player/d_a_player.h"
#include "d_system/d_a_player_manager.h"
#include "d_system/d_base.h"
#include "d_bases/d_profile.h"
#include <algorithm>
#include <array>
#include <iterator>
#include <numeric>

namespace
{

struct ActorName {
    dProfName profile;
    char name[256];
};

constexpr ActorName l_actor_formatted_names[] = {
  {dProf::YOSHI, "Yoshi"},
  {dProf::YOSHI_FIRE, "Yoshi Fire"},
  {dProf::EN_KURIBO, "Goomba"},
  {dProf::EN_PATA_KURIBO, "Paragoomba"},
  {dProf::EN_MAME_KURIBO, "Mini Goomba"},
  {dProf::EN_NOKONOKO, "Koopa Troopa"},
  {dProf::EN_PATAPATA, "Paratroopa"},
  {dProf::EN_MET, "Buzzy Beetle"},
  {dProf::EN_TOGEZO, "Spiny"},
  {dProf::EN_SAKASA_TOGEZO, "Upside-down Spiny"},
  {dProf::EN_BUBBLE, "Lava Bubble"},
  {dProf::EN_DOSUN, "Thwomp"},
  {dProf::EN_BIGDOSUN, "Big Thwomp"},
  {dProf::EN_JUGEM, "Lakitu"},
  {dProf::EN_JUGEM_COIN, "Lakitu"},
  {dProf::EN_EATJUGEM, "Lakitu"},
  {dProf::EN_JUGEM_BODY, "Lakitu"},
  {dProf::EN_TOGEMET, "Spike Top"},
  {dProf::EN_FIREBAR, "Fire Bar"},
  {dProf::EN_TOGETEKKYU, "Spike Ball"},
  {dProf::EN_BIG_TOGETEKKYU, "Big Spike Ball"},
  {dProf::EN_UP_DOKAN_PAKKUN, "Piranha Plant"},
  {dProf::EN_DOWN_DOKAN_PAKKUN, "Piranha Plant"},
  {dProf::EN_RIGHT_DOKAN_PAKKUN, "Piranha Plant"},
  {dProf::EN_LEFT_DOKAN_PAKKUN, "Piranha Plant"},
  {dProf::EN_UP_DOKAN_FPAKKUN, "Fire Piranha Plant"},
  {dProf::EN_DOWN_DOKAN_FPAKKUN, "Fire Piranha Plant"},
  {dProf::EN_RIGHT_DOKAN_FPAKKUN, "Fire Piranha Plant"},
  {dProf::EN_LEFT_DOKAN_FPAKKUN, "Fire Piranha Plant"},
  {dProf::EN_JIMEN_PAKKUN, "Piranha Plant"},
  {dProf::EN_JIMEN_BIG_PAKKUN, "Big Guy"},
  {dProf::EN_JIMEN_FPAKKUN, "Fire Piranha Plant"},
  {dProf::EN_JIMEN_BIG_FPAKKUN, "Big Fire Guy"},
  {dProf::EN_WALK_PAKKUN, "Stalking Piranha Plant"},
  {dProf::ICEBALL, "Ice Ball"},
  {dProf::PL_FIREBALL, "Fireball"},
  {dProf::PAKKUN_FIREBALL, "Piranha Plant Fireball"},
  {dProf::BROS_FIREBALL, "Fire Bro Fireball"},
  {dProf::BOOMERANG, "Boomerang"},
  {dProf::EN_FIREBROS, "Fire Bro"},
  {dProf::EN_BOOMERANGBROS, "Boomerang Bro"},
  {dProf::EN_HAMMERBROS, "Hammer Bro"},
  {dProf::EN_LIFT_HAMMERBROS, "Hammer Bro"},
  {dProf::EN_ICEBROS, "Ice Bro"},
  {dProf::HAMMER, "Hammer"},
  {dProf::EN_HIMANBROS, "Sledge Bro"},
  {dProf::MEGA_HAMMER, "Sledge Bro Hammer"},
  {dProf::BROS_ICEBALL, "Ice Bro Iceball"},
  {dProf::EN_KILLER, "Bullet Bill"},
  {dProf::EN_SEARCH_KILLER, "Bullseye Bill"},
  {dProf::EN_MAGNUM_KILLER, "Banzai Bill"},
  {dProf::EN_SEARCH_MAGNUM_KILLER, "Bullseye Banzai Bill"},
  {dProf::EN_BASABASA, "Swoop"},
  {dProf::WAKI_PARABOM, "Parabomb"},
  {dProf::EN_PARA_BOMHEI, "Parabomb"},
  {dProf::EN_BOMHEI, "Bob-omb"},
  {dProf::EN_MECHA_KOOPA, "Mechakoopa"},
  {dProf::EN_MOUSE, "Scaredy Rat"},
  {dProf::EN_BIRIKYU, "Amp"},
  {dProf::EN_LINE_BIRIKYU, "Amp"},
  {dProf::EN_CHOROBON, "Fuzzy"},
  {dProf::EN_SANBO, "Pokey"},
  {dProf::EN_SANBO_PARTS, "Pokey"},
  {dProf::EN_SANBO_EL, "Pokey"},
  {dProf::EN_GURUGURU, "Ball and Chain"},
  {dProf::EN_SYNCRO_BARNAR, "Burner"},
  {dProf::EN_BARNAR, "Burner"},
  {dProf::EN_LARGE_BARNAR, "Burner"},
  {dProf::ROT_BARNAR, "Burner"},
  {dProf::EN_GESSO, "Blooper"},
  {dProf::EN_BARAMAKI_GESSO, "Blooper Nanny"},
  {dProf::EN_GESSO_CHILD, "Blooper Baby"},
  {dProf::EN_PUKUPUKU_PARENT, "Cheep Cheep"},
  {dProf::EN_PUKUPUKU, "Cheep Cheep"},
  {dProf::EN_TOGEPUKU, "Spiny Cheep Cheep"},
  {dProf::EN_MIDDLE_PUKU, "Big Cheep Cheep"},
  {dProf::EN_KARON, "Dry Bones"},
  {dProf::EN_BIGKARON, "Big Dry Bones"},
  {dProf::EN_NET_NOKONOKO_LR, "Climbing Koopa"},
  {dProf::EN_NET_NOKONOKO_UD, "Climbing Koopa"},
  {dProf::EN_HANACHAN, "Wiggler"},
  {dProf::EN_BIG_HANACHAN, "Big Wiggler"},
  {dProf::EN_TERESA, "Boo"},
  {dProf::EN_BIG_TERESA, "Big Boo"},
  {dProf::EN_CROW, "Crowber"},
  {dProf::EN_BIGPILE_UNDER, "Skewer"},
  {dProf::EN_BIGPILE_UPPER, "Skewer"},
  {dProf::EN_BIGPILE_RIGHT, "Skewer"},
  {dProf::EN_BIGPILE_LEFT, "Skewer"},
  {dProf::EN_SUPER_BIGPILE_RIGHT, "Skewer"},
  {dProf::EN_SUPER_BIGPILE_LEFT, "Skewer"},
  {dProf::EN_GOKUBUTO_BIGPILE_UNDER, "Skewer"},
  {dProf::EN_GOKUBUTO_BIGPILE_UPPER, "Skewer"},
  {dProf::EN_WANWAN, "Chain Chomp"},
  {dProf::EN_JUMPPUKU, "Jumping Cheep Cheep"},
  {dProf::EN_TOBIPUKU, "Jumping Cheep Cheep"},
  {dProf::EN_IGAPUKU, "Porcupuffer"},
  {dProf::EN_FIRESNAKE, "Fire Snake"},
  {dProf::EN_BOSS_KAMECK, "Kamek"},
  {dProf::EN_SLIP_PENGUIN, "Cooligan"},
  {dProf::EN_SLIP_PENGUIN2, "Cooligan"},
  {dProf::EN_IGA_KURIBO, "Prickly Goomba"},
  {dProf::KAMECK_MAGIC, "Kamek's Magic"},
  {dProf::EN_KERONPA, "Fire Chomp"},
  {dProf::KERONPA_FIRE, "Fire Chomp"},
  {dProf::EN_BAKUBAKU, "Cheep Chomp"},
  {dProf::EN_BOSS_LARRY, "Larry Koopa"},
  {dProf::EN_BOSS_CASTLE_LARRY, "Larry Koopa"},
  {dProf::OBJ_LARRY, "Larry Koopa"},
  {dProf::EN_BOSS_WENDY, "Wendy O. Koopa"},
  {dProf::EN_BOSS_CASTLE_WENDY, "Wendy O. Koopa"},
  {dProf::OBJ_WENDY, "Wendy O. Koopa"},
  {dProf::EN_BOSS_IGGY, "Iggy Koopa"},
  {dProf::EN_BOSS_CASTLE_IGGY, "Iggy Koopa"},
  {dProf::EN_BOSS_LEMMY, "Lemmy Koopa"},
  {dProf::EN_BOSS_CASTLE_LEMMY, "Lemmy Koopa"},
  {dProf::EN_BOSS_MORTON, "Morton Koopa Jr."},
  {dProf::EN_BOSS_CASTLE_MORTON, "Morton Koopa Jr."},
  {dProf::OBJ_MORTON, "Morton Koopa Jr."},
  {dProf::EN_BOSS_ROY, "Roy Koopa"},
  {dProf::EN_BOSS_CASTLE_ROY, "Roy Koopa"},
  {dProf::OBJ_ROY, "Roy Koopa"},
  {dProf::EN_BOSS_LUDWIG, "Ludwig von Koopa"},
  {dProf::EN_BOSS_CASTLE_LUDWIG, "Ludwig von Koopa"},
  {dProf::OBJ_LUDWIG, "Ludwig von Koopa"},
  {dProf::EN_BOSS_KOOPA, "Bowser"},
  {dProf::KOOPA_FIRE, "Bowser Fire Breath"},
  {dProf::LARRY_FIRE, "Magic Fireball"},
  {dProf::KOKOOPA_RING, "Wendy Ring"},
  {dProf::OBJ_IGGY_WANWAN, "Iggy Chain Chomp"},
  {dProf::CASTLE_LUDWIG_BLITZ, "Ludwig's Magic"},
  {dProf::FIRE_BLITZ, "Magic Fire"},
  {dProf::EN_UNIZOO, "Urchin"},
  {dProf::EN_UNIRA, "Big Urchin"},
  {dProf::EN_KANIBO, "Huckit Crab"},
  {dProf::EN_KANITAMA, "Huckit Crab's Rock"},
  {dProf::EN_KOPONE, "Fish Bones"},
  {dProf::EN_AKOYA, "Clampy"},
  {dProf::EN_MIDDLE_KURIBO, "Giant Goomba"},
  {dProf::EN_LARGE_KURIBO, "Mega Goomba"},
  {dProf::EN_BEANS_KURIBO, "Micro Goomba"},
  {dProf::JR_CLOWN_A, "Junior Clown Car"},
  {dProf::JR_CLOWN_B, "Junior Clown Car"},
  {dProf::JR_CLOWN_C, "Junior Clown Car"},
  {dProf::JR_CLOWN_FOR_PLAYER, "Junior Clown Car"},
  {dProf::BOMB_JR_C, "Bowser Jr. Bomb"},
  {dProf::EN_BOSS_KOOPA_JR_A, "Bowser Jr."},
  {dProf::EN_BOSS_KOOPA_JR_B, "Bowser Jr."},
  {dProf::EN_BOSS_KOOPA_JR_C, "Bowser Jr."},
  {dProf::JR_FIRE, "Bowser Jr. Fire Breath"},
  {dProf::JR_FLOOR_FIRE, "Bowser Jr. Floor Fire"},
  {dProf::YOGAN_INTERMITTENT, "Lava Geyser"},
  {dProf::EN_IBARAMUSHI, "Bramball"},
  {dProf::EN_CHOCHIN_ANKOH, "Bulber"},
  {dProf::EN_MISTMAN, "Foo"},
  {dProf::EN_ROT_PAKKUN, "Rotating Piranha Plant"},
  {dProf::EN_POLTER, "Silly Flying Thing"},
  {dProf::EN_ICICLE, "Icicle"},
  {dProf::EN_CANNON_BULLET, "Cannonball"},
  {dProf::KAZAN_ROCK, "Volcano Rock"},
  {dProf::EN_CHOROPU, "Monty Mole"},
  {dProf::EN_MANHOLE_CHOROPU, "Monty Mole"},
  {dProf::EN_JELLY_FISH, "Jellybeam"},
  {dProf::EN_GABON, "Spike"},
  {dProf::GABON_ROCK, "Spike Rock"},
  {dProf::EN_KING_KILLER, "King Bill"},
  {dProf::EN_PATAMET, "Para-Beetle"},
  {dProf::EN_BIG_PATAMET, "Heavy Para-Beetle"},
  {dProf::EN_BIG_ICICLE, "Falling Big Icicle"},
  {dProf::EN_BARREL, "Barrel"},
  {dProf::LIFT_ZEN_TOGE, "Spiky Wall from 5-Tower"},

  // Other non-death message actors
  {dProf::CASTLE_BOSS_DOOR, "FNAF 1 Style Door"},
  {dProf::CASTLE_BOSS_KEY, "Castle Boss Key"},
  {dProf::EN_DOOR, "Door"},
  {dProf::EN_SWITCHDOOR, "Door"},
  {dProf::EN_OBAKEDOOR, "Ghost House Door"},
  {dProf::EN_TORIDEDOOR, "Tower Boss Door"},
  {dProf::EN_CASTLEDOOR, "Castle Boss Door"},
  {dProf::EN_KOOPADOOR, "Final Boss Door"},
  {dProf::PALM_TREE, "Palm Tree"},
  {dProf::NICE_BOAT, "NICE_BOAT"},
  {dProf::LADDER, "Ladder"},
  {dProf::EN_REDRING, "Red Coin Ring"},
  {dProf::EN_SNAKEBLOCK, "Snake Block"},
  {dProf::SLIP_PENGUIN2_GLASSES, "Cooligan Glasses"},
};

template <u32 N>
struct PackedActorNames {
    char names[N];

    u32 getSize() const
    {
        return N;
    }
};

constexpr std::array<u32, std::size(l_actor_formatted_names)> s_lengths = [] {
    std::array<u32, std::size(l_actor_formatted_names)> lengths;
    for (u32 i = 0; i < std::size(l_actor_formatted_names); i++) {
        u32 j;
        for (j = 0; l_actor_formatted_names[i].name[j] != '\0'; j++) {
        }
        lengths[i] = j;
    }
    return lengths;
}();

constexpr std::array<u32, std::size(l_actor_formatted_names)> s_sorted_indices = [] {
    std::array<u32, std::size(l_actor_formatted_names)> indices;
    std::iota(indices.begin(), indices.end(), 0);
    std::sort(indices.begin(), indices.end(), [&](u32 a, u32 b) {
        return s_lengths[a] > s_lengths[b];
    });
    return indices;
}();

template <u32 P, u32 N>
consteval PackedActorNames<P> ProcessPackActorNames(const ActorName (&names)[N], u32& offset)
{
    PackedActorNames<P> packedNames = {};

    auto writeByte = [&](char byte) { packedNames.names[offset++] = byte; };

    for (u32 i = 0; i < N; i++) {
        const ActorName& name = names[s_sorted_indices[i]];

        writeByte(char(u16(name.profile) >> 2));
        writeByte(char(u16(name.profile) << 6));

        // Search back to see if we have a copy of the same name
        s32 foundOffset = -1;
        u32 myLength = s_lengths[s_sorted_indices[i]];
        for (u32 j = 0; j < offset - 2;) {
            if (packedNames.names[j + 1] & 0x20) {
                j += 3;
                continue;
            }

            u32 len = (packedNames.names[j + 1] << 8) & 0x1F;
            len |= packedNames.names[j + 2];
            u32 next = j + 3 + len;
            if (next > offset - 2) {
                break;
            }

            u32 k = next - 1 - myLength;
            u32 l;
            for (l = 0; l < myLength; l++) {
                if (packedNames.names[k + l] != name.name[l]) {
                    break;
                }
            }

            if (l == myLength) {
                foundOffset = s32(k);
                break;
            }

            j = next;
        }

        if (foundOffset != -1) {
            packedNames.names[offset - 1] |= 0x20 | ((foundOffset >> 8) & 0x1F);
            writeByte(foundOffset);
            continue;
        }

        u32 loc = offset++;
        for (u32 j = 0; name.name[j] != '\0'; j++) {
            writeByte(name.name[j]);
        }
        writeByte('\0');
        packedNames.names[loc] = offset - loc - 1;
    }

    return packedNames;
}

template <u32 P, u32 N>
consteval PackedActorNames<P> PackActorNames(const ActorName (&names)[N])
{
    u32 offset = 0;
    return ProcessPackActorNames<P>(names, offset);
}

constexpr u32 s_packedSize = [] {
    u32 offset = 0;
    ProcessPackActorNames<0x1000>(l_actor_formatted_names, offset);
    return offset;
}();

constexpr PackedActorNames<s_packedSize> s_packedNames = [] {
    u32 offset = 0;
    return ProcessPackActorNames<s_packedSize>(l_actor_formatted_names, offset);
}();

} // namespace

[[address(0x801018C0)]]
const char* dProf::getName(u16 profile);

const char* dProf::getFormattedName(dBase_c* actor)
{
    if (actor == nullptr) {
        return nullptr;
    }

    if (auto player = actor->DynamicCast<dAcPy_c>()) {
        if (player->isItemKinopio()) {
            return "Road";
        }

        auto colorType = daPyMng_c::getPlayerColorType(player->mPlayerType);
        auto playerType = static_cast<PLAYER_TYPE_e>(colorType);

        switch (playerType) {
        default:
            return "Player";

        case PLAYER_TYPE_e::MARIO:
            return "Mario";
        case PLAYER_TYPE_e::LUIGI:
            return "Luigi";
        case PLAYER_TYPE_e::YELLOW_TOAD:
            return "Yoad";
        case PLAYER_TYPE_e::BLUE_TOAD:
            return "Bload";
        case PLAYER_TYPE_e::TOADETTE:
            return "Toadette";
        case PLAYER_TYPE_e::PURPLE_TOADETTE:
            return "Poadette";
        case PLAYER_TYPE_e::ORANGE_TOAD:
            return "Oroad";
        case PLAYER_TYPE_e::BLACK_TOAD:
            return "Blaod";
        }
    }

    dProfName name = actor->mProfName;
    auto names = s_packedNames.names;

    for (u32 i = 0; i < s_packedNames.getSize();) {
        u32 info = *(u32*) (names + i);
        u32 len = (info >> 8) & 0x1FFF;
        bool match = name == dProfName(info >> 22);
        if (info & 0x200000) {
            if (match) {
                return &names[len];
            }
            i += 3;
            continue;
        }

        if (match) {
            return &names[i + 3];
        }
        i += 3 + len;
    }

    dBase_c* base = actor->DynamicCast<dBase_c>();
    return base && base->mpNameString ? base->mpNameString : "an unknown force";
}
